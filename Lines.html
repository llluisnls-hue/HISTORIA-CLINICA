<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Historia Clínica Oftalmológica • PDF</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#ffffff;--fg:#111111;--mut:#6b7280;--line:#e5e7eb;--card:#f9fafb}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn,.pill{padding:8px 12px;border-radius:8px;cursor:pointer;border:1px solid #9ca3af}
  .btn{background:#f3f4f6}
  .pill{background:#eef2ff}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px}
  h2{margin:0 0 6px}
  .grid{display:grid;gap:10px}
  .cols2{grid-template-columns:repeat(2,1fr)}
  .cols3{grid-template-columns:repeat(3,1fr)}
  label{font-size:12px;color:var(--mut)}
  input,textarea{width:100%;padding:6px;border:1px solid var(--line);border-radius:6px}
  textarea{min-height:60px}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pair .box{background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ccc;padding:6px;font-size:12px}
  .mut{color:var(--mut);font-size:12px}
  .dark{--bg:#0f1115;--fg:#f5f7fb;--mut:#a3a7b0;--line:#2a2e37;--card:#171a21}
  .dark input,.dark textarea{background:#0f1115;color:#f5f7fb;border-color:#2a2e37}
</style>
</head>
<body>

<header>
  <strong>Historia Clínica Oftalmológica</strong>
  <button id="darkBtn" class="pill">Modo oscuro</button>
  <button id="fsBtn" class="pill">Pantalla completa</button>
  <button id="pdfBtn" class="btn">Guardar PDF</button>
  <button id="guardarPacienteBtn" class="btn">Guardar paciente</button>
  <button id="limpiarBtn" class="btn">Limpiar</button>
</header>

<main>
  <!-- Datos básicos -->
  <section class="card grid cols3">
    <div><label>Paciente</label><input id="paciente" /></div>
    <div><label>Documento</label><input id="dni" /></div>
    <div><label>Fecha</label><input id="fecha" type="date" /></div>
    <div><label>Edad</label><input id="edad" /></div>
    <div><label>Teléfono</label><input id="tel" /></div>
    <div><label>Correo</label><input id="correo" /></div>
  </section>

  <!-- Antecedentes -->
  <section class="card">
    <h2>Antecedentes</h2>
    <div class="grid cols2">
      <div><label>Personales patológicos</label><textarea id="ant_personales"></textarea></div>
      <div><label>Oculares</label><textarea id="ant_oculares"></textarea></div>
      <div style="grid-column:1/-1"><label>Familiares</label><textarea id="ant_familiares"></textarea></div>
    </div>
  </section>

  <!-- Anamnesis -->
  <section class="card">
    <h2>Anamnesis</h2>
    <div class="grid cols2">
      <div><label>Tiempo de enfermedad</label><input id="t_enfermedad"/></div>
      <div><label>Forma de inicio</label><input id="forma_inicio"/></div>
    </div>
    <div><label>Relato</label><textarea id="relato"></textarea></div>
    <div><label>Agudeza visual (autorreporte)</label><textarea id="av_reporte"></textarea></div>
    <div><label>Tratamiento actual</label><textarea id="tto_actual"></textarea></div>
  </section>

  <!-- Examen físico -->
  <section class="card">
    <h2>Examen físico</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
      <button id="normalOD" class="btn">Normal OD</button>
      <button id="normalOI" class="btn">Normal OI</button>
      <span class="mut">Plantilla normal: Párpado sin lesiones, Conjuntiva normocrómica, Esclera sin lesiones,
        Córnea clara, Cámara anterior formada, Iris/Pupila fotorreactiva, Movimientos oculares centrado, Cristalino transparente.</span>
    </div>
    <div class="pair">
      <div class="box">
        <h3>OD</h3>
        <input id="sa_parpado_od" placeholder="Párpado" />
        <input id="sa_conj_od" placeholder="Conjuntiva" />
        <input id="sa_esclera_od" placeholder="Esclera" />
        <input id="sa_cornea_od" placeholder="Córnea" />
        <input id="sa_ca_od" placeholder="Cámara anterior" />
        <input id="sa_iris_od" placeholder="Iris - Pupila" />
        <input id="sa_mov_od" placeholder="Movimientos oculares" />
        <input id="sa_crist_od" placeholder="Cristalino" />
      </div>
      <div class="box">
        <h3>OI</h3>
        <input id="sa_parpado_oi" placeholder="Párpado" />
        <input id="sa_conj_oi" placeholder="Conjuntiva" />
        <input id="sa_esclera_oi" placeholder="Esclera" />
        <input id="sa_cornea_oi" placeholder="Córnea" />
        <input id="sa_ca_oi" placeholder="Cámara anterior" />
        <input id="sa_iris_oi" placeholder="Iris - Pupila" />
        <input id="sa_mov_oi" placeholder="Movimientos oculares" />
        <input id="sa_crist_oi" placeholder="Cristalino" />
      </div>
    </div>
    <div class="grid cols3" style="margin-top:10px">
      <div><label>Tonometría OD (mmHg)</label><input id="tono_od" type="number" step="0.5" placeholder="ej. 14"/></div>
      <div><label>Tonometría OI (mmHg)</label><input id="tono_oi" type="number" step="0.5" placeholder="ej. 15"/></div>
      <div><label>Método</label><input id="tono_metodo" placeholder="Applanación / iCare / aire..." /></div>
    </div>
  </section>

  <!-- Auxiliares / Diagnóstico / Tratamiento -->
  <section class="card">
    <h2>Exámenes auxiliares a solicitar</h2>
    <textarea id="auxiliares"></textarea>

    <h2>Diagnóstico (CIE-10)</h2>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="cieInput" list="cieList" placeholder="Ej. H40.1 o 'glaucoma primario'"/>
      <datalist id="cieList"></datalist>
      <button id="agregarCIE" class="btn">Agregar CIE-10</button>
    </div>
    <textarea id="diagnostico" placeholder="Se agregan aquí los códigos y descripciones..."></textarea>

    <h2>Tratamiento</h2>
    <textarea id="tratamiento"></textarea>

    <h2>Órdenes médicas</h2>
    <textarea id="ordenes"></textarea>
  </section>

  <!-- Pacientes recientes -->
  <section class="card">
    <h2>Pacientes recientes</h2>
    <table id="pacientesTabla">
      <thead><tr><th>Nombre</th><th>Fecha guardado</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
/* ===== Helpers DOM ===== */
const $ = id => document.getElementById(id);
const val = id => ($(id)?.value || '').trim();

/* ===== Modo oscuro / pantalla completa / limpiar ===== */
$('darkBtn').onclick = () => document.body.classList.toggle('dark');
$('fsBtn').onclick   = () => !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen();
$('limpiarBtn').onclick = () => {
  if(confirm('¿Borrar todos los campos?')){
    document.querySelectorAll('input, textarea').forEach(e=>e.value='');
    localStorage.removeItem('hc_actual');
  }
};

/* ===== Plantilla “Normal” OD/OI ===== */
const plantilla = {
  parpado:"Sin lesiones",
  conj:"Normocrómica",
  esclera:"Sin lesiones",
  cornea:"Clara",
  ca:"Formada",
  iris:"Fotorreactiva",
  mov:"Centrado",
  crist:"Transparente"
};
$('normalOD').onclick = () => {
  $('sa_parpado_od').value=plantilla.parpado;
  $('sa_conj_od').value=plantilla.conj;
  $('sa_esclera_od').value=plantilla.esclera;
  $('sa_cornea_od').value=plantilla.cornea;
  $('sa_ca_od').value=plantilla.ca;
  $('sa_iris_od').value=plantilla.iris;
  $('sa_mov_od').value=plantilla.mov;
  $('sa_crist_od').value=plantilla.crist;
  autosave();
};
$('normalOI').onclick = () => {
  $('sa_parpado_oi').value=plantilla.parpado;
  $('sa_conj_oi').value=plantilla.conj;
  $('sa_esclera_oi').value=plantilla.esclera;
  $('sa_cornea_oi').value=plantilla.cornea;
  $('sa_ca_oi').value=plantilla.ca;
  $('sa_iris_oi').value=plantilla.iris;
  $('sa_mov_oi').value=plantilla.mov;
  $('sa_crist_oi').value=plantilla.crist;
  autosave();
};

/* ===== Auto-guardado ===== */
function getFormData(){
  const data={};
  document.querySelectorAll('input,textarea').forEach(el=>{ data[el.id]=el.value; });
  return data;
}
function fillForm(data){
  for(const k in data){ if($(k)) $(k).value=data[k]; }
}
function autosave(){ localStorage.setItem('hc_actual', JSON.stringify(getFormData())); }
document.querySelectorAll('input,textarea').forEach(el=>el.addEventListener('input', autosave));

/* Al cargar: restaurar último y render pacientes */
window.addEventListener('load', ()=>{
  const data = localStorage.getItem('hc_actual');
  if(data){ fillForm(JSON.parse(data)); }
  renderPacientes();
  cargarCIE10();
});

/* ===== Guardar paciente y listado ===== */
$('guardarPacienteBtn').onclick = () => {
  const pacientes = JSON.parse(localStorage.getItem('pacientes')||'[]');
  const p = getFormData();
  p.fechaGuardado = new Date().toLocaleString();
  pacientes.push(p);
  localStorage.setItem('pacientes', JSON.stringify(pacientes));
  renderPacientes();
};
function renderPacientes(){
  const pacientes = JSON.parse(localStorage.getItem('pacientes')||'[]');
  const tbody = $('pacientesTabla').querySelector('tbody');
  tbody.innerHTML='';
  pacientes.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${p.paciente || '—'}</td>
      <td>${p.fechaGuardado}</td>
      <td>
        <button onclick="cargarPaciente(${i})">Cargar</button>
        <button onclick="exportarPaciente(${i})">PDF</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
window.cargarPaciente = (i)=>{
  const pacientes = JSON.parse(localStorage.getItem('pacientes')||'[]');
  fillForm(pacientes[i]); autosave();
};
window.exportarPaciente = (i)=>{
  const pacientes = JSON.parse(localStorage.getItem('pacientes')||'[]');
  fillForm(pacientes[i]); autosave(); generarPDF();
};

/* ===== CIE-10: diccionario y buscador ===== */
/* Lista ampliada (común en oftalmología). Puedes seguir agregando más. */
const CIE10 = [
  {code:'H00.0', desc:'Orzuelo y otras inflamaciones profundas del párpado'},
  {code:'H00.1', desc:'Chalazión'},
  {code:'H01.0', desc:'Blefaritis'},
  {code:'H04.1', desc:'Ojo seco (Trastornos de la secreción lagrimal)'},
  {code:'H10.0', desc:'Conjuntivitis mucopurulenta'},
  {code:'H10.1', desc:'Conjuntivitis aguda atópica'},
  {code:'H10.4', desc:'Conjuntivitis aguda no especificada'},
  {code:'H11.0', desc:'Pingüécula'},
  {code:'H11.1', desc:'Pterigión'},
  {code:'H16.0', desc:'Úlcera de la córnea'},
  {code:'H16.2', desc:'Queratitis intersticial y profunda'},
  {code:'H17.9', desc:'Cicatriz corneal, no especificada'},
  {code:'H18.2', desc:'Degeneración marginal pelúcida / queratoglobo (otros trastornos corneales)'},
  {code:'H18.6', desc:'Queratocono'},
  {code:'H20.0', desc:'Iridociclitis aguda (Uveítis anterior)'},
  {code:'H21.0', desc:'Hifema'},
  {code:'H25.0', desc:'Catarata senil incipiente'},
  {code:'H25.1', desc:'Catarata senil nuclear'},
  {code:'H25.2', desc:'Catarata senil cortical'},
  {code:'H26.2', desc:'Catarata después de procedimientos quirúrgicos (secundaria)'},
  {code:'H27.0', desc:'Afaquia'},
  {code:'H35.0', desc:'Retinopatía de fondo, no diabética'},
  {code:'H35.3', desc:'Degeneración macular y del polo posterior'},
  {code:'H35.4', desc:'Desprendimiento del epitelio pigmentario de la retina'},
  {code:'H33.0', desc:'Desprendimiento de retina con desgarro'},
  {code:'H34.1', desc:'Oclusión de la arteria central de la retina'},
  {code:'H34.8', desc:'Oclusión venosa de la retina'},
  {code:'H40.1', desc:'Glaucoma primario de ángulo abierto'},
  {code:'H40.2', desc:'Glaucoma de ángulo cerrado'},
  {code:'H40.3', desc:'Glaucoma secundario'},
  {code:'H44.2', desc:'Alta miopía patológica'},
  {code:'H49.0', desc:'Parálisis del III par (oculomotor)'},
  {code:'H49.1', desc:'Parálisis del IV par (troclear)'},
  {code:'H49.2', desc:'Parálisis del VI par (abducens)'},
  {code:'H50.0', desc:'Esotropía'},
  {code:'H50.1', desc:'Exotropía'},
  {code:'H50.5', desc:'Heteroforia (foria)'},
  {code:'H52.0', desc:'Astigmatismo'},
  {code:'H52.1', desc:'Miopía'},
  {code:'H52.2', desc:'Hipermetropía'},
  {code:'H52.4', desc:'Presbicia'},
  {code:'H53.0', desc:'Amblyopía'},
  {code:'H53.1', desc:'Trastornos visuales subjetivos (fotopsias, etc.)'},
  {code:'H54.0', desc:'Ceguera y disminución de la visión (no especificada)'},
  {code:'H57.8', desc:'Otros trastornos del ojo y anexos'},
  {code:'T81.4', desc:'Infección posterior a procedimiento (útil postquirúrgico)'},
  {code:'Z96.1', desc:'Presencia de lente intraocular (LIO)'},
  {code:'E11.3', desc:'Diabetes tipo 2 con complicaciones oculares'},
  {code:'E10.3', desc:'Diabetes tipo 1 con complicaciones oculares'}
];
function cargarCIE10(){
  const dl=$('cieList'); dl.innerHTML='';
  CIE10.forEach(({code,desc})=>{
    const opt=document.createElement('option');
    opt.value=`${code} — ${desc}`;
    dl.appendChild(opt);
  });
}
function buscarCIE(q){
  q=q.toUpperCase();
  return CIE10.filter(({code,desc})=>
    code.toUpperCase().includes(q) || desc.toUpperCase().includes(q)
  ).slice(0,15);
}
$('cieInput').addEventListener('input', (e)=>{
  // (el datalist ya sugiere; aquí podríamos actualizar dinámicamente si quisiéramos)
});
$('agregarCIE').addEventListener('click', ()=>{
  const q = $('cieInput').value.trim();
  if(!q) return;
  let entry='';
  // si viene como "H40.1 — Glaucoma ..." úsalo directo
  if(q.includes('—')) entry=q;
  else{
    const f = buscarCIE(q)[0];
    if(!f){ alert('No se encontró CIE-10 con ese código/término.'); return; }
    entry = `${f.code} — ${f.desc}`;
  }
  const dx = $('diagnostico').value.trim();
  $('diagnostico').value = dx ? (dx + '\n' + entry) : entry;
  $('cieInput').value='';
  autosave();
});

/* ===== PDF profesional (paginado + firma abajo) ===== */
$('pdfBtn').onclick = () => generarPDF();
function generarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });

  const mm = v => v*2.83465;
  const MLEFT = mm(18), MRIGHT = mm(18), MTOP = mm(18), MBOT = mm(20);
  const PAGE_W = doc.internal.pageSize.getWidth();
  const PAGE_H = doc.internal.pageSize.getHeight();
  const CONTENT_W = PAGE_W - MLEFT - MRIGHT;
  const LINE_H = 16;
  let y = MTOP;

  function newPage(){ doc.addPage(); y = MTOP; }
  function ensureSpace(lines=1){ if(y + lines*LINE_H > PAGE_H - MBOT) newPage(); }
  function writeLine(text, opts={}){
    const x = opts.x ?? MLEFT;
    const maxWidth = opts.maxWidth ?? CONTENT_W;
    const font = opts.font ?? ['helvetica','normal'];
    const size = opts.size ?? 11;
    doc.setFont(font[0], font[1]); doc.setFontSize(size);
    const wrapped = doc.splitTextToSize(String(text ?? '—'), maxWidth);
    wrapped.forEach(ln=>{ ensureSpace(1); doc.text(ln, x, y); y += LINE_H; });
  }
  function writeTitle(text){ doc.setFont('helvetica','bold'); doc.setFontSize(12); ensureSpace(1); doc.text(text, MLEFT, y); y += LINE_H; }
  function KV(label,value){ writeLine(`${label}: ${value ? value : '—'}`); }

  // Toma de datos
  const data = getFormData();

  // Encabezado
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Historia Clínica Oftalmológica', MLEFT, y); y += LINE_H*1.6;

  // Ficha en 2 columnas
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  const colGap = mm(10), colW = (CONTENT_W - colGap)/2;
  let yL = y, yR = y;
  const left = [
    `Paciente: ${data.paciente||'—'}`,
    `DNI: ${data.dni||'—'}`,
    `Fecha: ${data.fecha||'—'}`
  ];
  const right = [
    `Edad: ${data.edad||'—'}`,
    `Tel: ${data.tel||'—'}`,
    `Correo: ${data.correo||'—'}`
  ];
  left.forEach(t=>{
    const lines=doc.splitTextToSize(t,colW);
    lines.forEach(ln=>{ if(yL+LINE_H>PAGE_H-MBOT){ newPage(); yL=MTOP; yR=Math.max(yR,yL);} doc.text(ln, MLEFT, yL); yL+=LINE_H; });
  });
  right.forEach(t=>{
    const lines=doc.splitTextToSize(t,colW);
    lines.forEach(ln=>{ if(yR+LINE_H>PAGE_H-MBOT){ newPage(); yR=MTOP; yL=Math.max(yL,yR);} doc.text(ln, MLEFT+colW+colGap, yR); yR+=LINE_H; });
  });
  y = Math.max(yL,yR) + LINE_H*0.6;

  // Antecedentes
  writeTitle('Antecedentes');
  KV('Personales', data.ant_personales);
  KV('Oculares',   data.ant_oculares);
  KV('Familiares', data.ant_familiares);
  y += 6;

  // Anamnesis
  writeTitle('Anamnesis');
  KV('Tiempo de enfermedad', data.t_enfermedad);
  KV('Forma de inicio',      data.forma_inicio);
  KV('Relato',               data.relato);
  KV('AV (autorreporte)',    data.av_reporte);
  KV('Tratamiento actual',   data.tto_actual);
  y += 6;

  // Examen físico – segmento anterior
  writeTitle('Examen físico – Segmento anterior (OD)');
  KV('Párpado',         data.sa_parpado_od);
  KV('Conjuntiva',      data.sa_conj_od);
  KV('Esclera',         data.sa_esclera_od);
  KV('Córnea',          data.sa_cornea_od);
  KV('Cámara anterior', data.sa_ca_od);
  KV('Iris-Pupila',     data.sa_iris_od);
  KV('Mov. oculares',   data.sa_mov_od);
  KV('Cristalino',      data.sa_crist_od);
  y += 6;

  writeTitle('Examen físico – Segmento anterior (OI)');
  KV('Párpado',         data.sa_parpado_oi);
  KV('Conjuntiva',      data.sa_conj_oi);
  KV('Esclera',         data.sa_esclera_oi);
  KV('Córnea',          data.sa_cornea_oi);
  KV('Cámara anterior', data.sa_ca_oi);
  KV('Iris-Pupila',     data.sa_iris_oi);
  KV('Mov. oculares',   data.sa_mov_oi);
  KV('Cristalino',      data.sa_crist_oi);
  y += 6;

  // Examen físico – segmento posterior
  writeTitle('Examen físico – Segmento posterior (OD)');
  KV('Nervio óptico',     data.sp_no_od);
  KV('Vasos sanguíneos',  data.sp_vasos_od);
  KV('Mácula',            data.sp_macula_od);
  KV('Retina periférica', data.sp_retina_od);
  y += 6;

  writeTitle('Examen físico – Segmento posterior (OI)');
  KV('Nervio óptico',     data.sp_no_oi);
  KV('Vasos sanguíneos',  data.sp_vasos_oi);
  KV('Mácula',            data.sp_macula_oi);
  KV('Retina periférica', data.sp_retina_oi);
  y += 6;

  // Tonometría
  writeTitle('Tonometría');
  KV('OD (mmHg)', data.tono_od);
  KV('OI (mmHg)', data.tono_oi);
  KV('Método',    data.tono_metodo);
  y += 6;

  // Auxiliares, Dx, Tratamiento, Órdenes
  writeTitle('Exámenes auxiliares a solicitar');
  writeLine(data.auxiliares);

  writeTitle('Diagnóstico (CIE-10)');
  writeLine(data.diagnostico);

  writeTitle('Tratamiento');
  writeLine(data.tratamiento);

  writeTitle('Órdenes médicas');
  writeLine(data.ordenes);

  // Firma más abajo
  ensureSpace(8);
  const yLine = y + LINE_H*4;
  doc.line( MLEFT, yLine, MLEFT + mm(80), yLine );
  doc.text('Firma / Sello', MLEFT, yLine + 18);

  const nombre = (data.paciente || 'historia').replace(/\s+/g,'_');
  doc.save(`HC_${nombre}.pdf`);
}
</script>
</body>
</html>
