<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Historia Clínica Oftalmológica • PDF</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#ffffff;--fg:#111111;--mut:#6b7280;--line:#e5e7eb;--card:#f9fafb}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border:1px solid #9ca3af;background:#f3f4f6;border-radius:8px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .pill{padding:8px 12px;border:1px solid #9ca3af;border-radius:999px;background:#eef2ff;cursor:pointer}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px}
  h2{margin:0 0 6px}
  .grid{display:grid;gap:10px}
  .cols2{grid-template-columns:repeat(2,1fr)}
  .cols3{grid-template-columns:repeat(3,1fr)}
  label{font-size:12px;color:var(--mut);display:block;margin-bottom:4px}
  input,textarea,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff;color:var(--fg)}
  textarea{min-height:70px;resize:vertical}
  .section-title{font-weight:700;margin-top:4px}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pair .box{background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px}
  .pair h3{margin:0 0 6px;font-size:14px}
  .mut{color:var(--mut);font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .right{margin-left:auto}
  .dark{--bg:#0f1115;--fg:#f5f7fb;--mut:#a3a7b0;--line:#2a2e37;--card:#171a21}
  .dark input,.dark textarea,.dark select{background:#0f1115;color:#f5f7fb;border-color:#2a2e37}
  .dark .btn{background:#171a21;border-color:#2a2e37}
  .dark .pill{background:#1e293b;border-color:#334155;color:#e5e7eb}
</style>
</head>
<body>

<header>
  <strong>Historia Clínica Oftalmológica</strong>
  <button id="darkBtn" class="pill">Modo oscuro</button>
  <button id="fsBtn" class="pill">Pantalla completa</button>
  <div class="right row">
    <button id="pdfBtn" class="btn">Guardar PDF</button>
    <button id="limpiarBtn" class="btn">Limpiar</button>
  </div>
</header>

<main>
  <!-- Datos básicos -->
  <section class="card grid cols3">
    <div>
      <label>Paciente</label>
      <input id="paciente" placeholder="Nombre completo" />
    </div>
    <div>
      <label>Documento</label>
      <input id="dni" placeholder="DNI / ID" />
    </div>
    <div>
      <label>Fecha</label>
      <input id="fecha" type="date" />
    </div>
    <div>
      <label>Edad</label>
      <input id="edad" placeholder="años" />
    </div>
    <div>
      <label>Teléfono</label>
      <input id="tel" placeholder="+51 ..." />
    </div>
    <div>
      <label>Correo</label>
      <input id="correo" placeholder="email@dominio.com" />
    </div>
  </section>

  <!-- Antecedentes -->
  <section class="card">
    <h2>Antecedentes</h2>
    <div class="grid cols2">
      <div>
        <label>Personales patológicos</label>
        <textarea id="ant_personales" placeholder="HTA, DM, alergias, medicación crónica..."></textarea>
      </div>
      <div>
        <label>Oculares</label>
        <textarea id="ant_oculares" placeholder="Cirugías, traumas, glaucoma, uveítis..."></textarea>
      </div>
      <div class="grid" style="grid-column:1/-1">
        <label>Familiares</label>
        <textarea id="ant_familiares" placeholder="Glaucoma, degeneración macular, estrabismo..."></textarea>
      </div>
    </div>
  </section>

  <!-- Anamnesis (plantilla) -->
  <section class="card">
    <h2>Anamnesis (plantilla)</h2>
    <div class="grid cols2">
      <div>
        <label>Tiempo de enfermedad</label>
        <input id="t_enfermedad" placeholder="p. ej., 3 semanas" />
      </div>
      <div>
        <label>Forma de inicio</label>
        <input id="forma_inicio" placeholder="Brusco / Insidioso / Intermitente" />
      </div>
    </div>
    <div class="grid cols2">
      <div>
        <label>Relato</label>
        <textarea id="relato" placeholder="Relato libre del paciente..."></textarea>
      </div>
      <div>
        <label>Agudeza visual (autorreporte)</label>
        <textarea id="av_reporte" placeholder="Dificultad de lejos/cerca, halos, fotopsias..."></textarea>
      </div>
    </div>
    <div>
      <label>Tratamiento actual</label>
      <textarea id="tto_actual" placeholder="Gotas, lentes de contacto, fármacos sistémicos..."></textarea>
    </div>
  </section>

  <!-- Examen físico -->
  <section class="card">
    <h2>Examen físico</h2>
    <!-- Segmento anterior -->
    <div class="section-title">Segmento anterior</div>
    <div class="pair">
      <div class="box">
        <h3>OD</h3>
        <div class="grid">
          <div><label>Párpado</label><input id="sa_parpado_od" placeholder="Normal / blefaritis / chalazión..."></div>
          <div><label>Conjuntiva</label><input id="sa_conj_od" placeholder="Inyectada / quemosis / normal..."></div>
          <div><label>Esclera</label><input id="sa_esclera_od" placeholder="Normal / ectasia..."></div>
          <div><label>Córnea</label><input id="sa_cornea_od" placeholder="Transparente / queratitis / haze..."></div>
          <div><label>Cámara anterior</label><input id="sa_ca_od" placeholder="Profundidad, celularidad, flare..."></div>
          <div><label>Iris - Pupila</label><input id="sa_iris_od" placeholder="Isocórica / midriasis / sinequias..."></div>
          <div><label>Movimientos oculares</label><input id="sa_mov_od" placeholder="EOM: normal / limitación..."></div>
          <div><label>Cristalino</label><input id="sa_crist_od" placeholder="Transparente / catarata..."></div>
        </div>
      </div>
      <div class="box">
        <h3>OI</h3>
        <div class="grid">
          <div><label>Párpado</label><input id="sa_parpado_oi" placeholder="..."></div>
          <div><label>Conjuntiva</label><input id="sa_conj_oi" placeholder="..."></div>
          <div><label>Esclera</label><input id="sa_esclera_oi" placeholder="..."></div>
          <div><label>Córnea</label><input id="sa_cornea_oi" placeholder="..."></div>
          <div><label>Cámara anterior</label><input id="sa_ca_oi" placeholder="..."></div>
          <div><label>Iris - Pupila</label><input id="sa_iris_oi" placeholder="..."></div>
          <div><label>Movimientos oculares</label><input id="sa_mov_oi" placeholder="..."></div>
          <div><label>Cristalino</label><input id="sa_crist_oi" placeholder="..."></div>
        </div>
      </div>
    </div>

    <!-- Segmento posterior -->
    <div class="section-title" style="margin-top:10px">Segmento posterior</div>
    <div class="pair">
      <div class="box">
        <h3>OD</h3>
        <div class="grid">
          <div><label>Nervio óptico</label><input id="sp_no_od" placeholder="Borde nítido / edema / excavación..."></div>
          <div><label>Vasos sanguíneos</label><input id="sp_vasos_od" placeholder="Calibre, cruces AV..."></div>
          <div><label>Mácula</label><input id="sp_macula_od" placeholder="Reflejo foveal / edema / drusas..."></div>
          <div><label>Retina periférica</label><input id="sp_retina_od" placeholder="Desgarros / degeneración lattice..."></div>
        </div>
      </div>
      <div class="box">
        <h3>OI</h3>
        <div class="grid">
          <div><label>Nervio óptico</label><input id="sp_no_oi" placeholder="..."></div>
          <div><label>Vasos sanguíneos</label><input id="sp_vasos_oi" placeholder="..."></div>
          <div><label>Mácula</label><input id="sp_macula_oi" placeholder="..."></div>
          <div><label>Retina periférica</label><input id="sp_retina_oi" placeholder="..."></div>
        </div>
      </div>
    </div>

    <!-- Tonometría -->
    <div class="grid cols3" style="margin-top:10px">
      <div>
        <label>Tonometría OD (mmHg)</label>
        <input id="tono_od" placeholder="ej. 14" />
      </div>
      <div>
        <label>Tonometría OI (mmHg)</label>
        <input id="tono_oi" placeholder="ej. 15" />
      </div>
      <div>
        <label>Método</label>
        <input id="tono_metodo" placeholder="Applanación / iCare / aire..." />
      </div>
    </div>
  </section>

  <!-- Auxiliares / Diagnóstico / Tratamiento / Órdenes -->
  <section class="card grid">
    <div>
      <h2>Exámenes auxiliares a solicitar</h2>
      <textarea id="auxiliares" placeholder="OCT mácula/NO, campo visual, paquimetría, topografía, angiografía..."></textarea>
    </div>
    <div>
      <h2>Diagnóstico</h2>
      <textarea id="diagnostico" placeholder="Dx principal y diferenciales..."></textarea>
    </div>
    <div class="grid cols2">
      <div>
        <h2>Tratamiento</h2>
        <textarea id="tratamiento" placeholder="Indicación médica, colirios, posología..."></textarea>
      </div>
      <div>
        <h2>Órdenes médicas</h2>
        <textarea id="ordenes" placeholder="Control en X días, signos de alarma, interconsultas..."></textarea>
      </div>
    </div>
    <div class="mut">Al guardar PDF se incluye un espacio de firma/sello.</div>
  </section>
</main>

<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const val = id => ($(id)?.value || '').trim();

/* ===== Modo oscuro ===== */
$('darkBtn').addEventListener('click',()=>document.body.classList.toggle('dark'));

/* ===== Pantalla completa ===== */
$('fsBtn').addEventListener('click',()=>{
  if(!document.fullscreenElement){document.documentElement.requestFullscreen?.();}else{document.exitFullscreen?.();}
});

/* ===== Limpiar ===== */
$('limpiarBtn').addEventListener('click',()=>{
  if(confirm('¿Borrar todos los campos?')) document.querySelectorAll('input, textarea').forEach(e=>e.value='');
});

/* ===== PDF ===== */
$('pdfBtn').addEventListener('click',()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const mm = v => v*2.83465;
  const L = mm(18), R = mm(190), W = mm(210), lineH = 16;
  let y = mm(18);

  // Encabezado
  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Historia Clínica Oftalmológica', L, y); y += lineH*1.6;

  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  const header = [
    `Paciente: ${val('paciente') || '—'}`,
    `DNI: ${val('dni') || '—'}`,
    `Fecha: ${val('fecha') || '—'}`,
    `Edad: ${val('edad') || '—'}`,
    `Tel: ${val('tel') || '—'}`,
    `Correo: ${val('correo') || '—'}`
  ];
  header.forEach((t,i)=>{
    const x = (i<3)?L:R;
    if(i===3) y -= lineH*3; // sube para columna derecha
    doc.text(t, x, y);
    y += lineH;
    if(i===2) { y = mm(18)+lineH*1.6; } // inicio col derecha
  });
  y = mm(18) + lineH*6.2;

  // Sección helper
  const section = (title,content)=>{
    doc.setFont('helvetica','bold'); doc.setFontSize(12);
    doc.text(title, L, y); y += lineH;
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    if(Array.isArray(content)){
      content.forEach(row=>{
        if(typeof row === 'string'){ doc.text(row || '—', L, y, {maxWidth: mm(175)}); y += lineH; }
        else{ // label: text
          doc.text(`${row[0]}: ${row[1] || '—'}`, L, y, {maxWidth: mm(175)}); y += lineH;
        }
      });
    } else {
      doc.text((content||'—'), L, y, {maxWidth: mm(175)});
      y += lineH * (1 + Math.ceil((content?.length||1)/95));
    }
    y += 6;
  };

  // Antecedentes
  section('Antecedentes', [
    ['Personales', val('ant_personales')],
    ['Oculares',   val('ant_oculares')],
    ['Familiares', val('ant_familiares')]
  ]);

  // Anamnesis
  section('Anamnesis', [
    ['Tiempo de enfermedad', val('t_enfermedad')],
    ['Forma de inicio',      val('forma_inicio')],
    ['Relato',               val('relato')],
    ['AV (autorreporte)',    val('av_reporte')],
    ['Tratamiento actual',   val('tto_actual')]
  ]);

  // Examen físico – Segmento anterior (OD/OI)
  section('Examen físico – Segmento anterior (OD)', [
    ['Párpado',        val('sa_parpado_od')],
    ['Conjuntiva',     val('sa_conj_od')],
    ['Esclera',        val('sa_esclera_od')],
    ['Córnea',         val('sa_cornea_od')],
    ['Cámara anterior',val('sa_ca_od')],
    ['Iris-Pupila',    val('sa_iris_od')],
    ['Mov. oculares',  val('sa_mov_od')],
    ['Cristalino',     val('sa_crist_od')]
  ]);
  section('Examen físico – Segmento anterior (OI)', [
    ['Párpado',        val('sa_parpado_oi')],
    ['Conjuntiva',     val('sa_conj_oi')],
    ['Esclera',        val('sa_esclera_oi')],
    ['Córnea',         val('sa_cornea_oi')],
    ['Cámara anterior',val('sa_ca_oi')],
    ['Iris-Pupila',    val('sa_iris_oi')],
    ['Mov. oculares',  val('sa_mov_oi')],
    ['Cristalino',     val('sa_crist_oi')]
  ]);

  // Examen físico – Segmento posterior (OD/OI)
  section('Examen físico – Segmento posterior (OD)', [
    ['Nervio óptico',    val('sp_no_od')],
    ['Vasos sanguíneos', val('sp_vasos_od')],
    ['Mácula',           val('sp_macula_od')],
    ['Retina periférica',val('sp_retina_od')]
  ]);
  section('Examen físico – Segmento posterior (OI)', [
    ['Nervio óptico',    val('sp_no_oi')],
    ['Vasos sanguíneos', val('sp_vasos_oi')],
    ['Mácula',           val('sp_macula_oi')],
    ['Retina periférica',val('sp_retina_oi')]
  ]);

  // Tonometría
  section('Tonometría', [
    ['OD (mmHg)', val('tono_od')],
    ['OI (mmHg)', val('tono_oi')],
    ['Método',    val('tono_metodo')]
  ]);

  // Auxiliares, Dx, Tratamiento, Órdenes
  section('Exámenes auxiliares a solicitar', val('auxiliares'));
  section('Diagnóstico', val('diagnostico'));
  section('Tratamiento', val('tratamiento'));
  section('Órdenes médicas', val('ordenes'));

  // Firma
  const yLine = Math.min(mm(780), y + lineH*2);
  doc.line(L, yLine, mm(100), yLine);
  doc.text('Firma / Sello', L, yLine + 14);

  const nombre = (val('paciente')||'historia').replace(/\s+/g,'_');
  doc.save(`HC_${nombre}.pdf`);
});
</script>
</body>
</html>
