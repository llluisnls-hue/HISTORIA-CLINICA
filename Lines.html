<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Historia Clínica Oftalmológica • PDF</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#ffffff;--fg:#111111;--mut:#6b7280;--line:#e5e7eb;--card:#f9fafb}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);padding:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn,.pill{padding:8px 12px;border-radius:8px;cursor:pointer;border:1px solid #9ca3af}
  .btn{background:#f3f4f6}
  .pill{background:#eef2ff}
  main{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:12px}
  h2{margin:0 0 6px}
  .grid{display:grid;gap:10px}
  .cols2{grid-template-columns:repeat(2,1fr)}
  .cols3{grid-template-columns:repeat(3,1fr)}
  label{font-size:12px;color:var(--mut)}
  input,textarea{width:100%;padding:6px;border:1px solid var(--line);border-radius:6px}
  textarea{min-height:60px}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pair .box{background:#fff;border:1px solid var(--line);border-radius:8px;padding:10px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ccc;padding:6px;font-size:12px}
  .dark{--bg:#0f1115;--fg:#f5f7fb;--mut:#a3a7b0;--line:#2a2e37;--card:#171a21}
  .dark input,.dark textarea{background:#0f1115;color:#f5f7fb;border-color:#2a2e37}
</style>
</head>
<body>

<header>
  <strong>Historia Clínica Oftalmológica</strong>
  <button id="darkBtn" class="pill">Modo oscuro</button>
  <button id="fsBtn" class="pill">Pantalla completa</button>
  <button id="pdfBtn" class="btn">Guardar PDF</button>
  <button id="guardarPacienteBtn" class="btn">Guardar paciente</button>
  <button id="limpiarBtn" class="btn">Limpiar</button>
</header>

<main>
  <!-- Datos básicos -->
  <section class="card grid cols3">
    <div><label>Paciente</label><input id="paciente" /></div>
    <div><label>Documento</label><input id="dni" /></div>
    <div><label>Fecha</label><input id="fecha" type="date" /></div>
    <div><label>Edad</label><input id="edad" /></div>
    <div><label>Teléfono</label><input id="tel" /></div>
    <div><label>Correo</label><input id="correo" /></div>
  </section>

  <!-- Antecedentes -->
  <section class="card">
    <h2>Antecedentes</h2>
    <div class="grid cols2">
      <div><label>Personales patológicos</label><textarea id="ant_personales"></textarea></div>
      <div><label>Oculares</label><textarea id="ant_oculares"></textarea></div>
      <div style="grid-column:1/-1"><label>Familiares</label><textarea id="ant_familiares"></textarea></div>
    </div>
  </section>

  <!-- Anamnesis -->
  <section class="card">
    <h2>Anamnesis</h2>
    <div class="grid cols2">
      <div><label>Tiempo de enfermedad</label><input id="t_enfermedad"/></div>
      <div><label>Forma de inicio</label><input id="forma_inicio"/></div>
    </div>
    <div><label>Relato</label><textarea id="relato"></textarea></div>
    <div><label>Agudeza visual (autorreporte)</label><textarea id="av_reporte"></textarea></div>
    <div><label>Tratamiento actual</label><textarea id="tto_actual"></textarea></div>
  </section>

  <!-- Examen físico -->
  <section class="card">
    <h2>Examen físico</h2>
    <button id="normalOD" class="btn">Normal OD</button>
    <button id="normalOI" class="btn">Normal OI</button>
    <div class="pair">
      <div class="box">
        <h3>OD</h3>
        <input id="sa_parpado_od" placeholder="Párpado" />
        <input id="sa_conj_od" placeholder="Conjuntiva" />
        <input id="sa_esclera_od" placeholder="Esclera" />
        <input id="sa_cornea_od" placeholder="Córnea" />
        <input id="sa_ca_od" placeholder="Cámara anterior" />
        <input id="sa_iris_od" placeholder="Iris - Pupila" />
        <input id="sa_mov_od" placeholder="Movimientos oculares" />
        <input id="sa_crist_od" placeholder="Cristalino" />
      </div>
      <div class="box">
        <h3>OI</h3>
        <input id="sa_parpado_oi" placeholder="Párpado" />
        <input id="sa_conj_oi" placeholder="Conjuntiva" />
        <input id="sa_esclera_oi" placeholder="Esclera" />
        <input id="sa_cornea_oi" placeholder="Córnea" />
        <input id="sa_ca_oi" placeholder="Cámara anterior" />
        <input id="sa_iris_oi" placeholder="Iris - Pupila" />
        <input id="sa_mov_oi" placeholder="Movimientos oculares" />
        <input id="sa_crist_oi" placeholder="Cristalino" />
      </div>
    </div>
    <div class="grid cols3" style="margin-top:10px">
      <div><label>Tonometría OD</label><input id="tono_od" placeholder="mmHg"/></div>
      <div><label>Tonometría OI</label><input id="tono_oi" placeholder="mmHg"/></div>
      <div><label>Método</label><input id="tono_metodo"/></div>
    </div>
  </section>

  <!-- Auxiliares / Diagnóstico / Tratamiento -->
  <section class="card">
    <h2>Exámenes auxiliares a solicitar</h2>
    <textarea id="auxiliares"></textarea>
    <h2>Diagnóstico (con CIE-10)</h2>
    <input id="cieInput" placeholder="Ej. H40.1 o glaucoma" />
    <textarea id="diagnostico"></textarea>
    <h2>Tratamiento</h2>
    <textarea id="tratamiento"></textarea>
    <h2>Órdenes médicas</h2>
    <textarea id="ordenes"></textarea>
  </section>

  <!-- Pacientes recientes -->
  <section class="card">
    <h2>Pacientes recientes</h2>
    <table id="pacientesTabla">
      <thead><tr><th>Nombre</th><th>Fecha</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
// ==== Diccionario CIE-10 básico ====
const cie10 = {
  "H40.1":"Glaucoma primario de ángulo abierto",
  "H52.1":"Miopía",
  "H52.2":"Hipermetropía",
  "H52.4":"Presbicia",
  "H25.0":"Catarata senil incipiente",
  "H10.0":"Conjuntivitis mucopurulenta"
};

// ==== Auto-guardado ====
document.querySelectorAll("input,textarea").forEach(el=>{
  el.addEventListener("input",()=>{
    localStorage.setItem("hc_actual", JSON.stringify(getFormData()));
  });
});

// ==== Recuperar último paciente ====
window.addEventListener("load",()=>{
  const data = localStorage.getItem("hc_actual");
  if(data){ fillForm(JSON.parse(data)); }
  renderPacientes();
});

// ==== Funciones de formulario ====
function getFormData(){
  const data={};
  document.querySelectorAll("input,textarea").forEach(el=>{ data[el.id]=el.value; });
  return data;
}
function fillForm(data){
  for(const k in data){ if($(k)) $(k).value=data[k]; }
}
function $(id){ return document.getElementById(id); }

// ==== Guardar paciente ====
$("guardarPacienteBtn").addEventListener("click",()=>{
  const pacientes=JSON.parse(localStorage.getItem("pacientes")||"[]");
  const p=getFormData();
  pacientes.push({...p,fechaGuardado:new Date().toLocaleString()});
  localStorage.setItem("pacientes",JSON.stringify(pacientes));
  renderPacientes();
});

// ==== Render pacientes recientes ====
function renderPacientes(){
  const pacientes=JSON.parse(localStorage.getItem("pacientes")||"[]");
  const tbody=$("pacientesTabla").querySelector("tbody");
  tbody.innerHTML="";
  pacientes.forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.paciente||'—'}</td><td>${p.fechaGuardado}</td>
      <td><button onclick="cargarPaciente(${i})">Cargar</button>
          <button onclick="exportarPaciente(${i})">PDF</button></td>`;
    tbody.appendChild(tr);
  });
}
function cargarPaciente(i){
  const pacientes=JSON.parse(localStorage.getItem("pacientes")||"[]");
  fillForm(pacientes[i]); 
  localStorage.setItem("hc_actual",JSON.stringify(pacientes[i]));
}
function exportarPaciente(i){
  const pacientes=JSON.parse(localStorage.getItem("pacientes")||"[]");
  fillForm(pacientes[i]);
  localStorage.setItem("hc_actual",JSON.stringify(pacientes[i]));
  generarPDF();
}

// ==== Botones examen físico normal ====
const plantilla = {
  parpado:"Sin lesiones",
  conj:"Normocrómica",
  esclera:"Sin lesiones",
  cornea:"Clara",
  ca:"Formada",
  iris:"Fotorreactiva",
  mov:"Centrado",
  crist:"Transparente"
};
$("normalOD").onclick=()=>{
  $("sa_parpado_od").value=plantilla.parpado;
  $("sa_conj_od").value=plantilla.conj;
  $("sa_esclera_od").value=plantilla.esclera;
  $("sa_cornea_od").value=plantilla.cornea;
  $("sa_ca_od").value=plantilla.ca;
  $("sa_iris_od").value=plantilla.iris;
  $("sa_mov_od").value=plantilla.mov;
  $("sa_crist_od").value=plantilla.crist;
};
$("normalOI").onclick=()=>{
  $("sa_parpado_oi").value=plantilla.parpado;
  $("sa_conj_oi").value=plantilla.conj;
  $("sa_esclera_oi").value=plantilla.esclera;
  $("sa_cornea_oi").value=plantilla.cornea;
  $("sa_ca_oi").value=plantilla.ca;
  $("sa_iris_oi").value=plantilla.iris;
  $("sa_mov_oi").value=plantilla.mov;
  $("sa_crist_oi").value=plantilla.crist;
};

// ==== Buscador CIE-10 ====
$("cieInput").addEventListener("input",e=>{
  const q=e.target.value.toUpperCase();
  let found="";
  for(const code in cie10){
    if(code.includes(q) || cie10[code].toUpperCase().includes(q)){
      found=`${code}: ${cie10[code]}`;
      break;
    }
  }
  $("diagnostico").value=found;
});

// ==== Modo oscuro / pantalla completa / limpiar ====
$("darkBtn").onclick=()=>document.body.classList.toggle("dark");
$("fsBtn").onclick=()=>!document.fullscreenElement?document.documentElement.requestFullscreen():document.exitFullscreen();
$("limpiarBtn").onclick=()=>{ if(confirm("¿Borrar todo?")) document.querySelectorAll("input,textarea").forEach(e=>e.value=""); };

// ==== PDF ====
$("pdfBtn").onclick=()=>generarPDF();
function generarPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF({unit:"pt",format:"a4"});
  doc.setFont("helvetica","normal");
  const data=getFormData();
  let y=40;
  doc.setFontSize(14); doc.text("Historia Clínica Oftalmológica",40,y); y+=30;
  doc.setFontSize(10);
  for(const k in data){ doc.text(`${k}: ${data[k]||'—'}`,40,y); y+=14; if(y>780){ doc.addPage(); y=40;} }
  doc.text("Firma / Sello",40,y+40);
  doc.save(`HC_${data.paciente||'paciente'}.pdf`);
}
</script>
</body>
</html>
